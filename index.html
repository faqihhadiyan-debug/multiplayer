<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>World Raid - Global Predator Sync</title>
    <style>
        :root { --red: #ff3333; --bg: #050505; }
        body { 
            margin: 0; background: var(--bg); color: white; 
            font-family: 'Segoe UI', sans-serif; text-align: center; 
            overflow: hidden; transition: background 0.2s;
        }
        
        .header { background: linear-gradient(to bottom, #500, #000); padding: 15px 10px; border-bottom: 2px solid var(--red); }
        #globalPop { font-size: 2.8rem; color: var(--red); font-weight: 900; text-shadow: 0 0 15px red; margin: 5px 0; }
        .user-meta { font-size: 0.75rem; color: #888; }

        .stage { height: 280px; display: flex; align-items: center; justify-content: center; position: relative; }
        #targetImg { 
            width: 190px; height: 190px; border-radius: 50%; 
            transition: transform 0.05s; filter: drop-shadow(0 0 20px rgba(255,0,0,0.3));
            z-index: 5;
        }

        .btn-attack { 
            width: 85%; max-width: 300px; padding: 20px; font-size: 1.6rem; 
            font-weight: 900; background: var(--red); color: white; 
            border: none; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 6px #600; outline: none; margin-bottom: 10px;
        }
        .btn-attack:active { transform: translateY(3px); box-shadow: 0 3px #200; }

        #attackFeed { height: 100px; overflow: hidden; padding: 10px; font-size: 0.8rem; background: #111; margin: 10px auto; width: 90%; max-width: 380px; border-radius: 15px; border: 1px solid #333; }
        .feed-entry { padding: 4px 0; border-bottom: 1px solid #1a1a1a; text-align: left; animation: fadeIn 0.3s ease; }
        
        /* ANIMASI SYNC */
        .shake-hit { animation: shake-fast 0.15s infinite; filter: sepia(1) saturate(10) hue-rotate(-50deg) !important; }
        @keyframes shake-fast {
            0% { transform: translate(3px, 3px); }
            50% { transform: translate(-3px, -2px); }
            100% { transform: translate(3px, -3px); }
        }

        .earth-explode { animation: explode-out 2s forwards !important; }
        @keyframes explode-out {
            0% { transform: scale(1); filter: brightness(1); }
            20% { transform: scale(1.5); filter: brightness(20); }
            100% { transform: scale(0); opacity: 0; filter: blur(40px); }
        }

        .dmg-text {
            position: absolute; color: #ff3333; font-weight: 900; font-size: 2rem;
            pointer-events: none; animation: float-up 0.8s ease-out forwards;
            z-index: 100; text-shadow: 2px 2px 0px black;
        }
        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-130px) scale(1.5); }
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .back-link { display: inline-block; margin: 10px 0; color: #444; text-decoration: none; font-size: 0.8rem; }
    </style>
</head>
<body>

<audio id="sndExplode" src="https://www.soundjay.com/buttons/sounds/bomb-02.mp3"></audio>

<div class="header">
    <small>POPULASI DUNIA</small>
    <div id="globalPop">8.000.000.000</div>
    <div class="user-meta">Predator: <b id="pName" style="color:white">---</b> | Power: <b id="pPower" style="color:#0f0">1</b></div>
</div>

<div class="stage" id="stage">
    <img src="https://upload.wikimedia.org/wikipedia/commons/2/22/Earth_Western_Hemisphere_transparent_background.png" id="targetImg">
</div>

<button class="btn-attack" id="raidBtn">GIGIT BUMI!</button>

<div id="attackFeed"></div>

<a href="https://faqih-roda.vercel.app/" class="back-link">‚Üê KEMBALI KE MENU</a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDF7Eg437poCL4J4OShMFtm2N6GQtnu01w",
        authDomain: "multiplayer-5e98b.firebaseapp.com",
        projectId: "multiplayer-5e98b",
        storageBucket: "multiplayer-5e98b.firebasestorage.app",
        messagingSenderId: "549080338588",
        appId: "1:549080338588:web:bac83f2ffbc77f47f9dd59"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const predatorName = localStorage.getItem('solo_uid') || "Predator";
    const myPower = parseInt(localStorage.getItem('last_power')) || 1;
    let localLastHit = 0;
    let isExploding = false;

    // Tampilkan Nama & Power
    document.getElementById('pName').innerText = predatorName;
    document.getElementById('pPower').innerText = myPower.toLocaleString();

    const globalRef = doc(db, "world", "earth");

    // Fungsi Munculkan Angka Melayang
    function spawnDmg(dmg) {
        const t = document.createElement('div');
        t.className = 'dmg-text'; t.innerText = "-"+dmg.toLocaleString();
        t.style.left = "50%"; t.style.top = "40%";
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 600);
    }

    // LISTENER (Satu-satunya koneksi ke Firebase)
    onSnapshot(globalRef, (snap) => {
        if(!snap.exists()) return;
        const d = snap.data();
        const earthImg = document.getElementById('targetImg');
        
        // Update Angka Populasi
        document.getElementById('globalPop').innerText = d.population.toLocaleString('id-ID');

        // 1. SYNC ANIMASI HIT (Muncul di semua perangkat)
        if (d.last_hit && d.last_hit !== localLastHit) {
            localLastHit = d.last_hit;
            earthImg.classList.add('shake-hit');
            document.body.style.backgroundColor = "#300";
            spawnDmg(d.last_dmg || 0);
            
            // Tampilkan Teks Riwayat Sementara
            if(d.last_name) {
                const feed = document.getElementById('attackFeed');
                feed.innerHTML = `<div class="feed-entry">üíÄ <b>${d.last_name}</b> baru saja menggigit!</div>`;
                // Hilangkan teks dari layar setelah 3 detik (di sisi klien saja)
                setTimeout(() => { feed.innerHTML = ""; }, 3000);
            }

            setTimeout(() => {
                earthImg.classList.remove('shake-hit');
                document.body.style.backgroundColor = "#050505";
            }, 100);
        }

        // 2. SYNC LEDAKAN
        if (d.population <= 0 && !isExploding) {
            isExploding = true;
            earthImg.classList.add('earth-explode');
            document.body.style.backgroundColor = "white";
            setTimeout(() => {
                updateDoc(globalRef, { 
                    population: 8000000000, 
                    last_hit: 0, 
                    last_name: "", 
                    last_dmg: 0 
                });
                earthImg.classList.remove('earth-explode');
                document.body.style.backgroundColor = "#050505";
                isExploding = false;
            }, 2000);
        }
    });

    // FUNGSI GIGIT (Menimpa data, bukan menambah)
    document.getElementById('raidBtn').onclick = async () => {
        if (isExploding) return;
        
        try {
            // Kita cuma UPDATE 1 dokumen yang sama terus-menerus
            // Ini tidak akan bikin Firebase penuh karena filenya cuma satu
            await updateDoc(globalRef, { 
                population: increment(-myPower),
                last_hit: Date.now(),
                last_dmg: myPower,
                last_name: predatorName
            });

            // TRICK: Hapus jejak nama di Firebase setelah 5 detik
            // Biar dokumen 'earth' kembali bersih/kosong namanya
            setTimeout(async () => {
                await updateDoc(globalRef, { last_name: "" });
            }, 5000);

        } catch (e) { console.error("Koneksi sibuk!"); }
    };
</script>

</body>
</html>
