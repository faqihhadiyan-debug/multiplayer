<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>World Raid - Live Feed</title>
    <style>
        :root { --red: #ff3333; --bg: #050505; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; text-align: center; }
        
        .header { background: linear-gradient(to bottom, #500, #000); padding: 25px 10px; border-bottom: 2px solid var(--red); }
        #globalPop { font-size: 3rem; color: var(--red); font-weight: 900; text-shadow: 0 0 15px red; margin: 10px 0; }
        
        #targetImg { width: 150px; height: 150px; border-radius: 50%; margin: 20px auto; display: block; transition: transform 0.05s; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
        #targetImg:active { transform: scale(0.9); }

        .btn-attack { width: 80%; max-width: 300px; padding: 20px; font-size: 1.5rem; font-weight: 900; background: var(--red); color: white; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 6px #600; outline: none; }
        .btn-attack:active { transform: translateY(3px); box-shadow: 0 3px #200; }

        /* Style untuk Riwayat Serangan (Live Feed) */
        .feed-container { background: #111; margin: 25px auto; width: 90%; max-width: 380px; border-radius: 15px; border: 1px solid #333; overflow: hidden; }
        .feed-title { background: #222; padding: 8px; font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        #attackFeed { height: 150px; overflow-y: hidden; padding: 10px; display: flex; flex-direction: column; }
        
        .feed-entry { font-size: 0.85rem; padding: 6px 0; border-bottom: 1px solid #1a1a1a; text-align: left; animation: fadeIn 0.3s ease; }
        .feed-entry b { color: var(--red); }
        .feed-entry i { color: #555; font-size: 0.7rem; float: right; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .back-btn { display: inline-block; margin: 20px 0; color: #666; text-decoration: none; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="header">
    <small>POPULASI DUNIA SAAT INI</small>
    <div id="globalPop">8.000.000.000</div>
    <div style="font-size: 0.8rem; color: #888;">Predator: <b id="pName">---</b> | Power: <b id="pPower" style="color:#0f0">1</b></div>
</div>

<img src="https://upload.wikimedia.org/wikipedia/commons/2/22/Earth_Western_Hemisphere_transparent_background.png" id="targetImg">

<button class="btn-attack" id="raidBtn">SERANG!</button>

<div class="feed-container">
    <div class="feed-title">Riwayat Serangan Global</div>
    <div id="attackFeed"></div>
</div>

<a href="index.html" class="back-btn">← KEMBALI KE SOLO</a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, increment, collection, addDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDF7Eg437poCL4J4OShMFtm2N6GQtnu01w",
        authDomain: "multiplayer-5e98b.firebaseapp.com",
        projectId: "multiplayer-5e98b",
        storageBucket: "multiplayer-5e98b.firebasestorage.app",
        messagingSenderId: "549080338588",
        appId: "1:549080338588:web:bac83f2ffbc77f47f9dd59"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ambil Data dari LocalStorage
    const predatorName = localStorage.getItem('solo_uid') || "Anonymous";
    const myPower = parseInt(localStorage.getItem('last_power')) || 1;

    document.getElementById('pName').innerText = predatorName;
    document.getElementById('pPower').innerText = myPower;

    const globalRef = doc(db, "world", "earth");

    // 1. Monitor Populasi Global
    onSnapshot(globalRef, (snap) => {
        if(snap.exists()) {
            document.getElementById('globalPop').innerText = snap.data().population.toLocaleString('id-ID');
        }
    });

    // 2. Monitor Live Feed (Riwayat Serangan)
    const qFeed = query(collection(db, "logs"), orderBy("time", "desc"), limit(5));
    onSnapshot(qFeed, (snap) => {
        const feedEl = document.getElementById('attackFeed');
        feedEl.innerHTML = "";
        snap.forEach(d => {
            const log = d.data();
            const div = document.createElement('div');
            div.className = 'feed-entry';
            div.innerHTML = `<span>⚡ <b>${log.name}</b> menyerang <b>-${log.dmg.toLocaleString()}</b></span>`;
            feedEl.appendChild(div);
        });
    });

    // 3. Fungsi Serang
    document.getElementById('raidBtn').onclick = async () => {
        if(navigator.vibrate) navigator.vibrate(30);
        
        try {
            // Kurangi populasi global
            updateDoc(globalRef, { population: increment(-myPower) });
            
            // Kirim riwayat serangan ke koleksi 'logs'
            addDoc(collection(db, "logs"), {
                name: predatorName,
                dmg: myPower,
                time: serverTimestamp()
            });
        } catch (e) { console.error("Gagal menyerang"); }
    };
</script>
</body>
</html>
