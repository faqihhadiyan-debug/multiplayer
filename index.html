<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>World Raid - Predator Online</title>
    <style>
        :root { --red: #ff3333; --bg: #050505; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; background: var(--bg); color: white; 
            font-family: sans-serif; text-align: center; 
            overflow: hidden; transition: background 0.2s; 
        }

        .header { 
            background: linear-gradient(to bottom, #500, #000); 
            padding: 15px; border-bottom: 2px solid var(--red); 
        }

        #globalPop { 
            font-size: 2.5rem; color: var(--red); 
            font-weight: 900; text-shadow: 0 0 10px red; 
        }

        .stage { 
            height: 260px; display: flex; align-items: center; 
            justify-content: center; position: relative; 
        }

        #targetImg { 
            width: 180px; height: 180px; border-radius: 50%; 
            transition: transform 0.05s; z-index: 5; 
        }

        .btn-attack { 
            width: 80%; padding: 18px; font-size: 1.5rem; 
            font-weight: 900; background: var(--red); color: white; 
            border: none; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 5px #600; outline: none; transition: 0.1s;
        }
        .btn-attack:active { transform: translateY(4px); box-shadow: 0 2px #300; }
        
        #attackFeed { 
            height: 100px; margin: 10px auto; width: 90%; 
            font-size: 0.8rem; color: #aaa; overflow: hidden; 
            display: flex; flex-direction: column-reverse; 
        }

        .feed-entry { padding: 2px 0; animation: fadeIn 0.2s forwards; }
        .fade-out { opacity: 0; }

        .shake-hit { animation: shake 0.1s infinite; filter: brightness(1.5) sepia(1); }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }
        
        .earth-explode { animation: explode 1.5s forwards; }
        @keyframes explode { 0% { transform: scale(1.5); filter: brightness(10); opacity: 0; } }
        
        .dmg-text { position: absolute; color: var(--red); font-weight: 900; animation: float 0.6s forwards; pointer-events: none; }
        @keyframes float { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-80px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .btn-back {
            display: inline-block; margin-top: 10px; color: #777;
            text-decoration: none; font-size: 0.8rem; border: 1px solid #333;
            padding: 8px 15px; border-radius: 20px;
        }
    </style>
</head>
<body>

<div class="header">
    <div id="globalPop">8.000.000.000</div>
    <div style="font-size: 0.7rem; color: #777;">
        üëæ <b id="pName">Memuat Akun...</b> | ‚öîÔ∏è Power: <b id="pPower">1</b>
    </div>
</div>

<div class="stage" id="stage">
    <img src="https://upload.wikimedia.org/wikipedia/commons/2/22/Earth_Western_Hemisphere_transparent_background.png" id="targetImg">
</div>

<button class="btn-attack" id="raidBtn">TELAN</button>
<div id="attackFeed"></div>

<a href="https://faqih-roda.vercel.app/" class="btn-back" id="navSolo">‚Üê KEMBALI KE MODE SOLO</a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, getDoc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // --- PAKAI CONFIG SOLO SUPAYA DATABASE NYAMBUNG ---
    const firebaseConfig = {
        apiKey: "AIzaSyD3tna4rUSr_FH0eb08aI3AX3Z-fVcqaj8",
        authDomain: "fruitsmasmaster.firebaseapp.com",
        projectId: "fruitsmasmaster",
        storageBucket: "fruitsmasmaster.firebasestorage.app",
        messagingSenderId: "673530855742",
        appId: "1:673530855742:web:ac1395bda6c68f764cac6f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const sfxAttack = new Audio('https://assets.mixkit.co/active_storage/sfx/2296/2296-preview.mp3');
    const bgmMulti = new Audio('https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/theme_01.mp3');
    bgmMulti.loop = true; bgmMulti.volume = 0.5;

    document.addEventListener('click', () => { if (bgmMulti.paused) bgmMulti.play(); }, { once: true });

    // --- SYNC AKUN SOLO KE MULTIPLAYER ---
    const deviceId = localStorage.getItem('solo_uid');
    let myPower = 1;
    let isExploding = false;

    if (!deviceId) {
        alert("Main mode Solo dulu buat dapet akun!");
        window.location.href = "https://faqih-roda.vercel.app/";
    } else {
        document.getElementById('pName').innerText = deviceId;
        // Ambil data power langsung dari koleksi 'players' mode Solo
        const playerRef = doc(db, "players", deviceId);
        onSnapshot(playerRef, (snap) => {
            if(snap.exists()) {
                myPower = snap.data().clickPower || 1;
                document.getElementById('pPower').innerText = myPower.toLocaleString();
            }
        });
    }

    const globalRef = doc(db, "world", "earth");

    function spawnDmg(dmg) {
        const t = document.createElement('div');
        t.className = 'dmg-text'; t.innerText = "-"+dmg.toLocaleString();
        t.style.left = (40 + Math.random() * 20) + "%"; 
        t.style.top = "40%";
        document.getElementById('stage').appendChild(t);
        setTimeout(() => t.remove(), 600);
    }

    onSnapshot(globalRef, (snap) => {
        if(!snap.exists()) return;
        const d = snap.data();
        const earthImg = document.getElementById('targetImg');
        document.getElementById('globalPop').innerText = d.population.toLocaleString('id-ID');

        if (d.last_hit) {
            earthImg.classList.add('shake-hit');
            document.body.style.backgroundColor = "#300";
            spawnDmg(d.last_dmg || 0);
            
            const feed = document.getElementById('attackFeed');
            const newEntry = document.createElement('div');
            newEntry.className = 'feed-entry';
            newEntry.innerHTML = `üíÄ <b>${d.last_name}</b> menelan`;
            feed.appendChild(newEntry);
            setTimeout(() => newEntry.remove(), 3000);

            setTimeout(() => {
                earthImg.classList.remove('shake-hit');
                document.body.style.backgroundColor = "#050505";
            }, 100);
        }

        if (d.population <= 0 && !isExploding) {
            isExploding = true;
            earthImg.classList.add('earth-explode');
            setTimeout(() => {
                updateDoc(globalRef, { population: 8000000000, last_hit: 0 });
                earthImg.classList.remove('earth-explode');
                isExploding = false;
            }, 1000);
        }
    });

    document.getElementById('raidBtn').onclick = async () => {
        if (isExploding) return;
        sfxAttack.play();
        await updateDoc(globalRef, { 
            population: increment(-myPower),
            last_hit: Date.now(),
            last_dmg: myPower,
            last_name: deviceId
        });
    };
</script>
</body>
</html>
