<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Predator Bumi - Multiplayer Online</title>
    <style>
        :root { --primary: #00ff00; --danger: #ff3333; --bg: #050505; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; background: var(--bg); color: #eee; 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center;
        }

        .container { width: 100%; max-width: 400px; padding: 20px; text-align: center; }
        
        /* Bar Status Atas */
        .header-multi { display: flex; justify-content: space-between; width: 100%; font-size: 0.7rem; color: #00ff00; margin-bottom: 15px; border-bottom: 1px solid #003300; padding-bottom: 5px; }

        /* Box Skor Global */
        .global-box { background: #000; padding: 20px; border-radius: 25px; border: 2px solid #004400; margin-bottom: 20px; box-shadow: 0 0 20px rgba(0,255,0,0.1); }
        #globalPop { color: var(--primary); font-weight: 900; font-size: 2.2rem; display: block; margin: 10px 0; text-shadow: 0 0 10px rgba(0,255,0,0.3); }
        
        /* Tombol Utama */
        .btn-multi { 
            width: 100%; padding: 40px 10px; font-size: 2rem; font-weight: 900; color: #fff; 
            background: linear-gradient(135deg, #006400, #002200); border: none; border-radius: 30px; 
            cursor: pointer; box-shadow: 0 6px #001100; outline: none; transition: 0.1s;
        }
        .btn-multi:active { transform: translateY(4px); box-shadow: 0 2px #000; }

        /* Stats Player */
        .player-stats { background: #111; padding: 15px; border-radius: 15px; margin-top: 20px; border: 1px solid #222; text-align: left; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }

        /* Tombol Navigasi - Anti Terabas */
        .btn-back { 
            width: 100%; padding: 14px; margin-top: 15px; cursor: pointer; 
            background: #222; color: #fff; border: 2px solid #444; 
            border-radius: 12px; font-weight: bold; font-size: 0.9rem;
            display: block; text-decoration: none; text-align: center;
        }
        .btn-back:hover { border-color: var(--danger); color: var(--danger); }

        /* Leaderboard */
        .leaderboard { margin-top: 25px; background: #000; padding: 15px; border-radius: 20px; border: 1px solid #111; }
        .entry { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #111; font-size: 0.8rem; }
        .me { color: #ffd700; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-multi">
        <span>PLAYER: <b id="pName">---</b></span>
        <span>STATUS: <b id="status">SINKRONISASI...</b></span>
    </div>

    <div class="global-box">
        <small style="color:#008800; letter-spacing: 1px;">POPULASI DUNIA (GLOBAL)</small>
        <span id="globalPop">0</span>
        <div style="font-size: 0.8rem; color: #666;">Semua pemain menyerang target yang sama!</div>
    </div>

    <button class="btn-multi" id="attackBtn">SERANG!</button>

    <div class="player-stats">
        <div class="stat-row"><span>üí∞ Koin Saya:</span> <b id="myCoins">0</b></div>
        <div class="stat-row"><span>‚öîÔ∏è Power Serang:</span> <b id="myPower">1</b></div>
    </div>

    <a href="index.html" class="btn-back" id="navSolo">‚¨ÖÔ∏è KEMBALI KE SOLO</a>

    <div class="leaderboard">
        <h3 style="margin: 0 0 10px 0; color: var(--primary); font-size: 0.9rem;">üèÜ TOP PREDATOR ONLINE</h3>
        <div id="multiList">Memuat skor...</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, increment, getDoc, setDoc, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3tna4rUSr_FH0eb08aI3AX3Z-fVcqaj8",
        authDomain: "fruitsmasmaster.firebaseapp.com",
        projectId: "fruitsmasmaster",
        storageBucket: "fruitsmasmaster.firebasestorage.app",
        messagingSenderId: "673530855742",
        appId: "1:673530855742:web:ac1395bda6c68f764cac6f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- AUDIO SYSTEM (Sesuai Request) ---
    const sfxAttack = new Audio('https://assets.mixkit.co/active_storage/sfx/2296/2296-preview.mp3'); 
    const sfxNav = new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3');
    const bgmMulti = new Audio('https://codeskulptor-demos.commondatastorage.googleapis.com/descent/background%20music.mp3');
    bgmMulti.loop = true;
    bgmMulti.volume = 0.4;

    let muteTimeout;

    function playActionMulti(sfx) {
        sfx.currentTime = 0;
        sfx.play();
        bgmMulti.muted = true; // MATI PAS KLIK
        clearTimeout(muteTimeout);
        muteTimeout = setTimeout(() => { bgmMulti.muted = false; }, 500); // NYALA LAGI SETELAH 0.5s
    }

    document.addEventListener('click', () => { if (bgmMulti.paused) bgmMulti.play(); }, { once: true });

    // --- MULTIPLAYER LOGIC ---
    const deviceId = localStorage.getItem('solo_uid') || "GUEST_" + Math.floor(Math.random()*1000);
    document.getElementById('pName').innerText = deviceId;

    let myLocalData = { coins: 0, power: 1 };

    // 1. Monitor Populasi Global (Real-time)
    const globalRef = doc(db, "game", "world_stats");
    onSnapshot(globalRef, (snap) => {
        if (snap.exists()) {
            document.getElementById('globalPop').innerText = Math.floor(snap.data().population).toLocaleString('id-ID');
            document.getElementById('status').innerText = "ONLINE";
        } else {
            setDoc(globalRef, { population: 8000000000 });
        }
    });

    // 2. Monitor Data Pribadi
    const playerRef = doc(db, "players", deviceId);
    onSnapshot(playerRef, (snap) => {
        if (snap.exists()) {
            const d = snap.data();
            myLocalData.coins = d.consumed || 0;
            myLocalData.power = d.clickPower || 1;
            document.getElementById('myCoins').innerText = Math.floor(myLocalData.coins).toLocaleString('id-ID');
            document.getElementById('myPower').innerText = myLocalData.power;
        }
    });

    // 3. Monitor Leaderboard Global
    const q = query(collection(db, "players"), orderBy("consumed", "desc"), limit(5));
    onSnapshot(q, (snap) => {
        const list = document.getElementById('multiList');
        list.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            list.innerHTML += `<div class="entry ${d.id === deviceId ? 'me' : ''}">
                <span>${d.id}</span>
                <span>üí∞ ${Math.floor(p.consumed || 0).toLocaleString()}</span>
            </div>`;
        });
    });

    // --- ATTACK ACTION ---
    document.getElementById('attackBtn').onclick = async () => {
        playActionMulti(sfxAttack);
        if(navigator.vibrate) navigator.vibrate(30);

        try {
            // Update Populasi Dunia (Minus) & Update Koin Player (Plus)
            await updateDoc(globalRef, { population: increment(-myLocalData.power) });
            await updateDoc(playerRef, { consumed: increment(myLocalData.power) });
        } catch (e) {
            console.error("Gagal menyerang:", e);
        }
    };

    // --- NAVIGASI ---
    document.getElementById('navSolo').onclick = (e) => {
        e.preventDefault();
        playActionMulti(sfxNav);
        setTimeout(() => { window.location.href = 'index.html'; }, 450);
    };

</script>
</body>
</html>
